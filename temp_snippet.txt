import React, { useState } from 'react'
import { useParams } from 'react-router-dom'
import { PageHeader } from '../../../shared/components/PageHeader'
import { Spinner } from '../../../shared/components/Spinner'
import { ProductImages } from '../components/ProductImages'
import { PropertiesEditor } from '../components/PropertiesEditor'
import { DescriptionEditor } from '../components/DescriptionEditor'
import { SeoEditor } from '../components/SeoEditor'
import { ProductStoresEditor } from '../components/ProductStoresEditor'
import { useAddVariant, useDeleteVariant, useSetCategories, useUpdateBasics, useUpdateVariant } from '../queries'
import { BrandSelect } from '../components/BrandSelect'
import { CategoryMultiSelect } from '../components/CategoryMultiSelect'
import { useBrands, useCategories, useLeafCategories, useCountries } from '../queries'
import { useProduct } from '../queries'
import { useQueryClient } from '@tanstack/react-query'
import * as api from '../api'

export function ProductDetailPage() {
  const { id } = useParams<{ id: string }>()
  const { data: product, isLoading } = useProduct(id)
  const qc = useQueryClient()
  const pid = id ?? ''
  const addVariant = useAddVariant(pid)
  const deleteVariant = useDeleteVariant(pid)
  const updateVariant = useUpdateVariant(pid)
  const updateBasics = useUpdateBasics(pid)
  const setCats = useSetCategories(pid)
  const { data: brands } = useBrands()
  const { data: cats } = useCategories()
  const { data: leafCats } = useLeafCategories()
  const { data: countries, isLoading: loadingCountries } = useCountries()

  const [name, setName] = useState('')
  const [slug, setSlug] = useState('')
  const [code, setCode] = useState('')
  const [warehouseCode, setWarehouseCode] = useState('')
  const [countryCode, setCountryCode] = useState<string>('')
  const [brandId, setBrandId] = useState<string>('')
  const [categoryIds, setCategoryIds] = useState<string[]>([])
  const [primaryCatId, setPrimaryCatId] = useState<string>('')
  const [desc, setDesc] = useState('')
  // inline edit for variants
  const [editingVariantId, setEditingVariantId] = useState<string | null>(null)
  const [tmpVariantValue, setTmpVariantValue] = useState('')
  const [tmpVariantSku, setTmpVariantSku] = useState('')
  const [tmpVariantActive, setTmpVariantActive] = useState<boolean>(true)

  React.useEffect(() => {
    if (product) {
      setDesc(product.description ?? '')
      setPrimaryCatId(product.primaryCategoryId || '')
      setCountryCode(product.countryCode || '')
    }
  }, [product?.id])

  // Primary را فقط از سرور یا اقدام کاربر تنظیم می‌کنیم؛
  // از تنظیم خودکار بر اساس انتخاب‌ها صرف نظر می‌کنیم تا مقدار ذخیره‌شده بازنویسی نشود.

  if (isLoading) return <Spinner />
  if (!product) return <div className="text-sm">محصول یافت نشد.</div>

  return (
    <div className="space-y-4">
      <PageHeader title={`جزئیات محصول: ${product.name}`} />
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div className="lg:col-span-2 card p-4 space-y-6 divide-y divide-gray-200">
          <h3 className="font-semibold">مشخصات (قابل ویرایش)</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="label">نام</label>
              <input className="input" value={name || product.name} onChange={e=>setName(e.target.value)} />
            </div>
            <div>
              <label className="label">Slug</label>
              <input className="input" value={slug || product.defaultSlug} onChange={e=>setSlug(e.target.value)} />
            </div>
            <div>
              <label className="label">کد</label>
              <input className="input" value={code || product.code} onChange={e=>setCode(e.target.value)} />
            </div>
            <div>
              <label className="label">کد انبار</label>
              <input className="input" value={warehouseCode || product.warehouseCode || ''} onChange={e=>setWarehouseCode(e.target.value)} />
            </div>
            <div className="md:col-span-2">
              <BrandSelect value={brandId || product.brandId} onChange={(id)=> setBrandId(id)} />
            </div>
            <div className="md:col-span-2">
              <label className="label">کشور سازنده</label>
              {loadingCountries ? (
                <div className="text-xs text-gray-500">Loading...</div>
              ) : (
                <select
                  className="input"
                  value={countryCode || product.countryCode || ''}
                  onChange={e => setCountryCode(e.target.value)}
                >
                  <option value="">—</option>
                  {countries?.map(c => (
                    <option key={c.code2} value={c.code2}>
                      {(c.nameFa || c.nameEn) + ` (${c.code2})`}
                    </option>
                  ))}
                </select>
              )}
            </div>
          </div>
          <div className="pt-2">
            <button className="btn" onClick={async ()=>{
              try {
                await updateBasics.mutateAsync({
                  name: name || product.name,
                  slug: slug || product.defaultSlug,
                  code: code || product.code,
                  warehouseCode: (warehouseCode !== '' ? warehouseCode : (product.warehouseCode ?? null)),
                  brandId: (brandId || product.brandId)!,
                  countryCode: (countryCode !== '' ? countryCode : (product.countryCode ?? null)),
                })
                alert('ذخیره شد')
              } catch (e:any) { alert(e?.message || 'خطا در ذخیره مشخصات') }
            }}>ذخیره مشخصات</button>
          </div>
          <div className="pt-3 flex gap-2">
            {product.status === 'Active' ? (
              <button className="btn-red" onClick={async () => {
                try { await api.hideProduct(product.id); await qc.invalidateQueries({ queryKey: ['products','detail', product.id] }); alert('مخفی شد') } catch (e:any) { alert(e?.message || 'خطا در مخفی‌سازی') }
              }}>مخفی کردن</button>
            ) : (
              <button className="btn-green" onClick={async () => {
                try { await api.activateProduct(product.id); await qc.invalidateQueries({ queryKey: ['products','detail', product.id] }); alert('فعال شد') } catch (e:any) { alert(e?.message || 'خطا در فعال‌سازی') }
              }}>فعال‌سازی</button>
            )}
          </div>
        </div>
        <ProductImages product={product} />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div className="lg:col-span-2 card p-4 space-y-3">
          <h3 className="font-semibold">ویرایش توضیحات</h3>
          <DescriptionEditor value={desc} onChange={setDesc} />
          <button className="btn" onClick={async () => {
            try { await api.setProductDescription(product.id, desc); await qc.invalidateQueries({ queryKey: ['products','detail', product.id] }); alert('ذخیره شد'); } catch (e:any) { alert(e?.message || 'خطا در ذخیره توضیحات') }
          }}>ذخیره توضیحات</button>
          <div className="pt-4 space-y-2">
            <h3 className="font-semibold">تنوع محصول</h3>
            <div className="text-xs text-gray-600">کلید تنوع فعلی: {product.variationKey ?? '—'}</div>
            <div className="flex items-center gap-2">
              <input id="vk" className="input" placeholder="Variation Key (مثلاً رنگ)" />
              <button className="btn" onClick={async ()=>{
                const vk = (document.getElementById('vk') as HTMLInputElement)?.value || ''
                try { await api.setVariation(product.id, vk || null); await qc.invalidateQueries({ queryKey: ['products','detail', product.id] }); alert('ذخیره شد') } catch(e:any){ alert(e?.message || 'خطا در ذخیره Variation Key') }
              }}>ذخیره</button>
            </div>

            <div className="border rounded">
              <div className="grid grid-cols-5 gap-2 px-3 py-2 bg-gray-50 text-xs">
                <div className="col-span-2">مقدار</div>
                <div className="col-span-2">SKU</div>
                <div>وضعیت</div>
              </div>
              {product.variants.map(v => (
                <div key={v.id} className="grid grid-cols-5 gap-2 px-3 py-2 border-b last:border-0 text-sm items-center">
                  <div className="col-span-2"><span className="cursor-pointer underline" onClick={()=>{ setEditingVariantId(v.id); setTmpVariantValue(v.value); setTmpVariantSku(v.sku); setTmpVariantActive(v.isActive); }}>{v.value}</span></div>
                  <div className="col-span-2 font-mono">{v.sku}</div>
                  <div className="flex items-center justify-end gap-2 text-xs whitespace-nowrap">
                    <button className="btn px-2 py-1 text-xs flex-shrink-0" onClick={async ()=>{
                      try { await addVariant.mutateAsync({ value: v.value, sku: v.sku, isActive: !v.isActive }) }
                      catch(e:any){ alert(e?.message || 'Update failed') }
                    }}>{v.isActive ? 'Deactivate' : 'Activate'}</button>
                    <span className="text-xs flex-shrink-0">{v.isActive ? 'فعال' : 'غیرفعال'}</span>
                    <button className="btn-red px-2 py-1 text-xs flex-shrink-0" onClick={async ()=>{ if(!confirm('حذف شود؟')) return; try { await deleteVariant.mutateAsync(v.id) } catch(e:any){ alert(e?.message || 'خطا در حذف') } }}>حذف</button>
                  </div>
                </div>
              ))}
              {editingVariantId && (
                <div className="px-3 py-3 border-t space-y-2">
                  <div className="text-sm font-semibold">ویرایش ویژگی</div>
                  <div className="grid grid-cols-5 gap-2 items-center">
                    <input className="input col-span-2" placeholder="Value" value={tmpVariantValue} onChange={e=>setTmpVariantValue(e.target.value)} />
                    <input className="input col-span-2 font-mono" placeholder="SKU" value={tmpVariantSku} onChange={e=>setTmpVariantSku(e.target.value)} />
                    <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={tmpVariantActive} onChange={e=>setTmpVariantActive(e.target.checked)} /> Active</label>
                  </div>
                  <div className="flex gap-2">
                    <button className="btn" onClick={async ()=>{
                      try {
                        await updateVariant.mutateAsync({ variantId: editingVariantId!, value: tmpVariantValue, sku: tmpVariantSku, isActive: tmpVariantActive })
                        setEditingVariantId(null)
                      } catch(e:any){ alert((e && e.message) || (e && e.toString()) || 'Update failed') }
                    }}>Save</button>
                    <button className="btn-secondary" onClick={()=> setEditingVariantId(null)}>Cancel</button>
                  </div>
                </div>
              )}
              <div className="grid grid-cols-5 gap-2 px-3 py-2">
                <input id="nv" className="input sm:col-span-2" placeholder="مقدار (مثلاً قرمز)" />
                <input id="ns" className="input sm:col-span-2" placeholder="SKU" />
                <label className="flex items-center gap-2 text-sm"><input id="na" type="checkbox" defaultChecked /> فعال</label>
                <div className="col-span-5">
                  <button className="btn" onClick={async ()=>{
                    const value = (document.getElementById('nv') as HTMLInputElement)?.value || ''
                    const sku = (document.getElementById('ns') as HTMLInputElement)?.value || ''
                    const isActive = (document.getElementById('na') as HTMLInputElement)?.checked ?? true
                    try { await addVariant.mutateAsync({ value, sku, isActive }) } catch(e:any){ alert(e?.message || 'خطا در افزودن تنوع') }
                  }}>افزودن تنوع</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div className="card p-4 space-y-4 divide-y divide-gray-200">
          <h3 className="font-semibold">ویژگی‌ها</h3>
          <div className="border rounded">
            <div className="grid grid-cols-6 gap-2 px-3 py-2 bg-gray-50 text-xs">
              <div className="col-span-2">کلید</div>
              <div className="col-span-3">مقدار</div>
              <div>عملیات</div>
            </div>
            {product.properties.map(p => (
              <div key={p.id} className="grid grid-cols-6 gap-2 px-3 py-2 border-b last:border-0 items-center text-sm">
                <div className="col-span-2 font-mono">{p.key}</div>
                <div className="col-span-3 truncate">{p.valueString ?? ''}</div>
                <div className="flex items-center gap-2">
                  <button className="btn-red px-2 py-1" onClick={async ()=>{
                    if (!confirm('حذف شود؟')) return
                    try { await api.deleteProperty(product.id, p.id); await qc.invalidateQueries({ queryKey: ['products','detail', product.id] }); alert('حذف شد') } catch(e:any){ alert(e?.message || 'خطا در حذف') }
                  }}>حذف</button>
                </div>
              </div>
            ))}
          </div>
          <div className="pt-2">
            <h4 className="font-semibold">افزودن ویژگی جدید</h4>
            <PropertiesEditor value={[]} onChange={async (items)=>{
              try {
                for (const it of items) {
                  if (it.key.trim()) await api.upsertProductProperty(product.id, { key: it.key.trim(), valueString: it.value })
                }
                await qc.invalidateQueries({ queryKey: ['products','detail', product.id] });
                alert('ذخیره شد')
              } catch(e:any){ alert(e?.message || 'خطا در افزودن ویژگی') }
            }} />
          </div>

          <div className="pt-4 space-y-2">
            <h3 className="font-semibold">دسته‌بندی محصول</h3>
            <CategoryMultiSelect
              value={categoryIds.length ? categoryIds : product.categories.map(c=>c.categoryId)}
              onChange={setCategoryIds}
              primaryId={primaryCatId}
              onSetPrimary={async (cid) => {
                try {
                  setPrimaryCatId(cid)
                  // اطمینان از لینک بودن دسته و برگ بودن لیست باقی‌مانده
                  const baseIds = (categoryIds.length ? categoryIds : product.categories.map(c=>c.categoryId))
                  const ensured = baseIds.includes(cid) ? baseIds : [...baseIds, cid]
                  const leafSet = new Set((leafCats ?? []).map(c => c.id))
                  const ids = ensured.filter(id => leafSet.has(id) || id === cid)
                  setCategoryIds(ids)
                  // فراخوانی اختصاصی برای تنظیم primary در سرور
                  await api.setPrimaryCategory(product.id, cid)
                  await qc.invalidateQueries({ queryKey: ['products','detail', product.id] })
                  alert('Saved')
                } catch (e:any) {
                  alert(e?.message || 'Failed to set primary')
                }
              }}
            />
            <button className="btn" onClick={async ()=>{
              const leafSet = new Set((leafCats ?? []).map(c => c.id))
              const baseIds = (categoryIds.length ? categoryIds : product.categories.map(c=>c.categoryId))
              const ids = baseIds.filter(id => leafSet.has(id))
              try {
                await setCats.mutateAsync({ categoryIds: ids, primaryCategoryId: primaryCatId || undefined })
                alert("Saved")
              } catch (e:any) {
                alert(e?.message || 'Failed to update categories')
              }
            }}>ذخیره دسته‌ها</button>
          </div>
        </div>
      </div>

      <SeoEditor product={product} />
      <ProductStoresEditor product={product} />
    </div>
  )
}




